# Delivery API

<Note>
  **Production Ready** - Module complet avec 4 types de livraison testÃ©s et validÃ©s
</Note>

L'API Delivery est une plateforme complÃ¨te de gestion de livraisons avec 4 modules spÃ©cialisÃ©s, un systÃ¨me de pricing optimisÃ©, et des protections contre les race conditions.

## ðŸ“¦ Modules Disponibles

<CardGroup cols={2}>
  <Card title="Standard Delivery" icon="box" href="/api-reference/delivery-standard">
    Livraisons point-Ã -point simples et express
    - Base: 500 FCFA + 80 FCFA/km
    - Express: 700 FCFA + 85 FCFA/km
    - Assignation automatique d'agent
  </Card>
  
  <Card title="Grouped Delivery" icon="boxes-stacked" href="/api-reference/delivery-grouped">
    Livraisons groupÃ©es multi-zones (1-5 zones)
    - Base: 600 FCFA + 80 FCFA/km
    - Progression par zone
    - Optimisation de tournÃ©e
  </Card>
  
  <Card title="Moving Service" icon="truck-moving" href="/api-reference/delivery-moving">
    Service de dÃ©mÃ©nagement complet
    - Base: 10000 FCFA + 500 FCFA/km
    - Gestion d'Ã©quipe et inventaire
    - Calcul automatique des besoins
  </Card>
  
  <Card title="Overview" icon="book" href="/api-reference/delivery-overview">
    Vue d'ensemble et ressources partagÃ©es
    - Architecture
    - Flux de statuts
    - Bonnes pratiques
  </Card>
</CardGroup>

## âœ… Statut de Production

| FonctionnalitÃ© | Statut | Notes |
|----------------|--------|-------|
| **STANDARD Delivery** | âœ… Production Ready | TestÃ© de bout en bout |
| **EXPRESS Delivery** | âœ… Production Ready | PrioritÃ© et tarif majorÃ© |
| **GROUPED Delivery** | âœ… Production Ready | Multi-zones avec progression individuelle |
| **MOVING Service** | âœ… Production Ready | Ã‰quipe, inventaire, calcul besoins |
| **Pricing System** | âœ… Production Ready | Arrondi automatique au 100 FCFA supÃ©rieur |
| **Agent Assignment** | âœ… Production Ready | Protection race condition atomique |
| **Status Progression** | âœ… Production Ready | Protection race condition atomique |
| **Real-time Tracking** | ðŸš§ En dÃ©veloppement | Via module Pulse |
| **Cancellation** | ðŸš§ Ã€ implÃ©menter | Avec gestion remboursement |

## ðŸŽ¯ Pricing Structure

Tous les prix incluent **10% de frais de service** et sont **arrondis Ã  la centaine supÃ©rieure**.

### Exemples de Prix

| Type | Distance | Prix CalculÃ© | Prix Final |
|------|----------|--------------|------------|
| STANDARD | 5 km | 987 FCFA | **1000 FCFA** |
| EXPRESS | 5 km | 1235 FCFA | **1300 FCFA** |
| GROUPED (2 zones) | 10 km | 2720 FCFA | **2800 FCFA** |
| MOVING | 15 km + 20mÂ³ | 64900 FCFA | **64900 FCFA** |

<Tip>
  Les prix sont toujours arrondis vers le haut : 101 FCFA â†’ 200 FCFA, 567 FCFA â†’ 600 FCFA
</Tip>

## ðŸ”’ SÃ©curitÃ© & Performance

### Protection Race Conditions

Le module implÃ©mente des protections atomiques au niveau base de donnÃ©es :

<AccordionGroup>
  <Accordion title="Agent Assignment Protection">
    **ProblÃ¨me rÃ©solu** : EmpÃªche qu'un agent soit assignÃ© Ã  trop de commandes simultanÃ©ment
    
    **Solution** : VÃ©rification atomique SQL avec `NOT EXISTS` pour compter les commandes actives
    
    ```sql
    WHERE agent_id IS NULL 
      AND NOT EXISTS (
        SELECT 1 FROM delivery_orders 
        WHERE agent_id = $1 
        AND status NOT IN ('Pending', 'Delivered', 'Cancelled')
      )
    ```
    
    **RÃ©sultat** : Agent limitÃ© Ã  4-5 commandes actives maximum
  </Accordion>
  
  <Accordion title="Status Progression Protection">
    **ProblÃ¨me rÃ©solu** : EmpÃªche les sauts de statuts (Pending â†’ Delivered directement)
    
    **Solution** : VÃ©rification du statut actuel dans la clause WHERE
    
    ```sql
    UPDATE delivery_orders 
    SET status = $new_status 
    WHERE id = $order_id 
      AND status = $expected_current_status
    ```
    
    **RÃ©sultat** : Progression sÃ©quentielle garantie
  </Accordion>
</AccordionGroup>

### Performance

- **Assignation** : < 100ms (recherche optimisÃ©e avec distance Haversine)
- **Progression statut** : < 50ms (update atomique)
- **Estimation prix** : < 10ms (calcul en mÃ©moire)
- **CrÃ©ation commande** : < 200ms (avec validation et pricing)

## ðŸ”§ Ressources Communes

### Authentification

<Warning>
  Toutes les routes nÃ©cessitent un token JWT valide
</Warning>

```http
Authorization: Bearer <access_token>
```

### Agents (Livreurs)

<CodeGroup>
```bash CrÃ©er un agent
curl -X POST https://api.ono.ci/api/delivery/agents \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "zone_ids": [],
    "max_concurrent_orders": 3
  }'
```

```bash DÃ©marrer shift
curl -X POST https://api.ono.ci/api/delivery/agents/shift/start \
  -H "Authorization: Bearer $TOKEN"
```

```bash Mettre Ã  jour localisation
curl -X PUT https://api.ono.ci/api/delivery/agents/location \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "lat": 5.36,
    "lng": -4.01
  }'
```

```bash Mettre Ã  jour statut
curl -X PUT https://api.ono.ci/api/delivery/agents/status \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "status": "AVAILABLE"
  }'
```
</CodeGroup>

### Estimation de Prix

```bash
curl -X POST https://api.ono.ci/api/delivery/standard/estimate \
  -H "Content-Type: application/json" \
  -d '{
    "pickup_location": {"lat": 5.36, "lng": -4.01},
    "delivery_location": {"lat": 5.32, "lng": -4.03},
    "delivery_type": "STANDARD"
  }'
```

**RÃ©ponse** :
```json
{
  "success": true,
  "data": {
    "base_price": 500.0,
    "distance_km": 4.97,
    "distance_price": 397.6,
    "total_price": 1000.0,
    "estimated_duration_minutes": 15,
    "delivery_type": "STANDARD"
  }
}
```

## ðŸ“Š Flux de Statuts

### Standard & Express

```mermaid
graph LR
    A[Pending] --> B[Assigned]
    B --> C[EnRouteToPickup]
    C --> D[ArrivedAtPickup]
    D --> E[PackagePickedUp]
    E --> F[EnRouteToDelivery]
    F --> G[ArrivedAtDelivery]
    G --> H[Delivered]
```

### Grouped Delivery

**Statut Global** : Pending â†’ Assigned â†’ EnRouteToPickup â†’ ArrivedAtPickup â†’ PackagesPickedUp â†’ ProcessingZones â†’ AllZonesCompleted

**Statut par Zone** : Pending â†’ EnRouteToDelivery â†’ ArrivedAtDelivery â†’ Delivered

### Moving Service

MÃªme flux que Standard/Express, avec gestion d'Ã©quipe en plus.

## ðŸ§ª Tests & Validation

<Tip>
  Collection Postman complÃ¨te disponible : `ONO_DELIVERY_Complete.postman_collection.json`
</Tip>

### Tests EffectuÃ©s

- âœ… CrÃ©ation de commandes (tous types)
- âœ… Assignation automatique d'agents
- âœ… Progression complÃ¨te des statuts
- âœ… Calcul de prix avec arrondi
- âœ… Protection race conditions
- âœ… Gestion multi-zones (GROUPED)
- âœ… Gestion Ã©quipe et inventaire (MOVING)

### Commandes de Test

```bash
# Test complet STANDARD
curl -X POST https://api.ono.ci/api/delivery/standard/orders \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "pickup_address": "Cocody Riviera",
    "pickup_location": {"lat": 5.36, "lng": -4.01},
    "pickup_contact": "+225 0707070707",
    "delivery_address": "Plateau Centre",
    "delivery_location": {"lat": 5.32, "lng": -4.03},
    "delivery_contact": "+225 0708080808",
    "package_description": "Test",
    "is_fragile": false,
    "delivery_type": "STANDARD",
    "priority": "Normal",
    "payment_method": "Cash"
  }'
```

## ðŸš€ Prochaines Ã‰tapes

<Steps>
  <Step title="ImplÃ©menter Cancellation">
    Ajouter endpoint d'annulation avec gestion des remboursements
  </Step>
  
  <Step title="IntÃ©grer Tracking Temps RÃ©el">
    Connecter avec le module Pulse pour SSE/WebSocket
  </Step>
  
  <Step title="Ajouter Timeout Automatique">
    Fonction PostgreSQL + cron pour libÃ©rer les commandes bloquÃ©es
  </Step>
  
  <Step title="Optimiser Assignation">
    IntÃ©grer PostGIS pour calcul de distance SQL natif
  </Step>
</Steps>

## ðŸ“š Documentation DÃ©taillÃ©e

Pour plus d'informations sur chaque module :

- [Standard Delivery](/api-reference/delivery-standard) - API complÃ¨te STANDARD/EXPRESS
- [Grouped Delivery](/api-reference/delivery-grouped) - API complÃ¨te GROUPED
- [Moving Service](/api-reference/delivery-moving) - API complÃ¨te MOVING
- [Architecture](/api-reference/delivery-overview) - Architecture technique dÃ©taillÃ©e