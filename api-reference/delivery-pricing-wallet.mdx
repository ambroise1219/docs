# Pricing & Wallet System

<Note>
  **Production Ready** - Syst√®me complet de tarification et gestion de wallet pour agents
</Note>

Le syst√®me de Pricing & Wallet offre un contr√¥le total sur la tarification des livraisons et la gestion des paiements des agents livreurs.

## üéØ Vue d'ensemble

Le syst√®me comprend deux composants principaux :

1. **Pricing Configuration** - Configuration flexible des frais de livraison avec 2 modes (Standard & Flat Rate Zone)
2. **Agent Wallet** - Gestion des cr√©dits et paiements des agents avec d√©duction automatique

## üí∞ Syst√®me de Pricing

### Modes de Tarification

Le syst√®me supporte **2 modes exclusifs** configurables via le dashboard Super Admin :

#### Mode STANDARD (par d√©faut)

**Calcul** : Base + (Distance √ó Prix/km) + Multiplicateurs

**Formule** :
```
Prix = base_fee + (distance_km √ó price_per_km) √ó (1 + multiplicateurs)
```

**Exemple** (10 km) :
- Base: 500 FCFA
- Distance: 10 km √ó 100 FCFA/km = 1000 FCFA
- Total: 1500 FCFA
- Commission agent (15%): 225 FCFA

#### Mode FLAT_RATE_ZONE (nouveau)

**Calcul** : Prix fixe par zone si distance ‚â§ max

**Logique** :
1. D√©tecter zone pickup (lat/lng)
2. D√©tecter zone delivery (lat/lng)
3. Si **m√™me zone** ET **distance ‚â§ flat_rate_max_distance_km** :
   - Prix = **flat_rate_price** (ex: 800 FCFA)
   - **Ignorer TOUS les multiplicateurs**
4. Sinon : Calcul STANDARD

**Exemple** (Cocody, 8 km) :
- Zone: Cocody
- Distance: 8 km ‚â§ 10 km max
- Prix: **800 FCFA** (fixe, peu importe pluie/embouteillage)

**Exemple** (Cocody, 12 km) :
- Zone: Cocody
- Distance: 12 km > 10 km max
- Prix: Calcul STANDARD (base + distance)

### Configuration Globale

#### R√©cup√©rer la configuration (Public)

```bash
GET /api/delivery/pricing/config
```

**R√©ponse** :
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "pricing_mode": "STANDARD",
    "fees_enabled": true,
    "agent_commission_enabled": true,
    "agent_commission_rate": "15",
    "platform_commission_rate": "15",
    "base_fee": "500",
    "price_per_km": "100",
    "rush_hour_multiplier": "0",
    "weather_multiplier": "0",
    "demand_multiplier": "0",
    "fragile_multiplier": "0",
    "urgent_multiplier": "0",
    "min_delivery_fee": "500",
    "max_delivery_fee": null,
    "free_delivery_distance_km": "0",
    "max_delivery_distance_km": "50",
    "zone_pricing_enabled": false,
    "updated_at": "2025-11-05T18:00:00Z"
  }
}
```

#### Modifier la configuration (Super Admin)

```bash
PUT /api/delivery/pricing/config
Authorization: Bearer <super_admin_token>
Content-Type: application/json

{
  "pricing_mode": "FLAT_RATE_ZONE",
  "fees_enabled": true,
  "agent_commission_enabled": true,
  "agent_commission_rate": 15.0,
  "base_fee": 500.0,
  "price_per_km": 100.0,
  "rush_hour_multiplier": 0.2,
  "weather_multiplier": 0.15,
  "demand_multiplier": 0.1,
  "fragile_multiplier": 0.1,
  "urgent_multiplier": 0.25,
  "reason": "Activation mode flat rate pour Abidjan"
}
```

### Param√®tres Configurables

| Param√®tre | Type | Description | D√©faut |
|-----------|------|-------------|--------|
| `pricing_mode` | Enum | STANDARD ou FLAT_RATE_ZONE | STANDARD |
| `fees_enabled` | Boolean | Activer/D√©sactiver les frais (mode gratuit) | true |
| `agent_commission_enabled` | Boolean | Activer/D√©sactiver commission agent | true |
| `agent_commission_rate` | Float | Pourcentage commission agent (%) | 15.0 |
| `platform_commission_rate` | Float | Pourcentage commission plateforme (%) | 15.0 |
| `base_fee` | Float | Frais de base (FCFA) | 500.0 |
| `price_per_km` | Float | Prix par kilom√®tre (FCFA) | 100.0 |
| `rush_hour_multiplier` | Float | Multiplicateur heures de pointe | 0.0 |
| `weather_multiplier` | Float | Multiplicateur m√©t√©o | 0.0 |
| `demand_multiplier` | Float | Multiplicateur forte demande | 0.0 |
| `fragile_multiplier` | Float | Multiplicateur colis fragile | 0.0 |
| `urgent_multiplier` | Float | Multiplicateur livraison urgente | 0.0 |

<Tip>
  Tous les multiplicateurs sont √† **0 par d√©faut** (d√©sactiv√©s). Configurez-les selon vos besoins.
</Tip>

### Calcul de Prix

#### Mode STANDARD

```bash
POST /api/delivery/pricing/calculate
Content-Type: application/json

{
  "distance_km": 10.0,
  "is_fragile": false,
  "is_urgent": false,
  "is_rush_hour": false
}
```

#### Mode FLAT_RATE_ZONE (avec coordonn√©es)

```bash
POST /api/delivery/pricing/calculate
Content-Type: application/json

{
  "distance_km": 8.0,
  "pickup_lat": 5.35,
  "pickup_lng": -4.01,
  "delivery_lat": 5.36,
  "delivery_lng": -4.00,
  "is_fragile": false,
  "is_urgent": false,
  "is_rush_hour": false
}
```

**R√©ponse** :
```json
{
  "success": true,
  "data": {
    "base_fee": "500",
    "distance_fee": "1000",
    "distance_km": 10.0,
    "multipliers_applied": [],
    "subtotal": "1500",
    "agent_commission": "225.00",
    "total": "1500",
    "breakdown": {
      "base_fee": "500",
      "distance_fee": "1000",
      "rush_hour_fee": "0",
      "weather_fee": "0",
      "demand_fee": "0",
      "fragile_fee": "0",
      "urgent_fee": "0",
      "agent_commission": "225.00",
      "total": "1500"
    }
  }
}
```

### Zones de Tarification

#### Cr√©er une zone (Super Admin)

```bash
POST /api/delivery/pricing/zones
Authorization: Bearer <super_admin_token>
Content-Type: application/json

{
  "name": "Cocody",
  "description": "Zone Cocody avec tarif forfaitaire",
  "geometry": {
    "type": "Polygon",
    "coordinates": [[
      [-4.02, 5.34],
      [-4.00, 5.34],
      [-4.00, 5.37],
      [-4.02, 5.37],
      [-4.02, 5.34]
    ]]
  },
  "base_fee": 500.0,
  "price_per_km": 100.0,
  "min_fee": 500.0,
  "max_fee": 5000.0,
  "priority": 1,
  "flat_rate_enabled": true,
  "flat_rate_price": 800.0,
  "flat_rate_max_distance_km": 10.0
}
```

#### Lister les zones (Public)

```bash
GET /api/delivery/pricing/zones
```

**R√©ponse** :
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "name": "Cocody",
      "description": "Zone Cocody avec tarif forfaitaire",
      "flat_rate_enabled": true,
      "flat_rate_price": "800",
      "flat_rate_max_distance_km": "10",
      "is_active": true,
      "created_at": "2025-11-05T10:00:00Z"
    }
  ]
}
```

#### Supprimer une zone (Super Admin)

```bash
DELETE /api/delivery/pricing/zones/{zone_id}
Authorization: Bearer <super_admin_token>
```

### Historique des Modifications (Super Admin)

```bash
GET /api/delivery/pricing/history?limit=50
Authorization: Bearer <super_admin_token>
```

**R√©ponse** :
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "field_name": "pricing_mode",
      "old_value": "STANDARD",
      "new_value": "FLAT_RATE_ZONE",
      "changed_by": "admin-uuid",
      "changed_at": "2025-11-05T18:00:00Z",
      "reason": "Activation mode flat rate pour Abidjan"
    }
  ]
}
```

## üí≥ Syst√®me de Wallet

### Fonctionnement

Le wallet agent fonctionne selon ce flux :

1. **Cr√©ation automatique** - Un wallet est cr√©√© automatiquement pour chaque agent lors de son inscription
2. **V√©rification avant assignation** - Avant d'assigner une livraison, le syst√®me v√©rifie :
   - Wallet actif (status = ACTIVE)
   - Solde ‚â• 15% du montant de la commande
3. **D√©duction automatique** - Apr√®s assignation r√©ussie :
   - D√©duction imm√©diate de 15% du wallet
   - Transaction enregistr√©e
   - Notification agent
4. **Recharge** - L'agent peut recharger son wallet via Mobile Money (√† venir) ou admin

### Endpoints Wallet

#### Consulter mon wallet (Agent)

```bash
GET /api/wallet
Authorization: Bearer <agent_token>
```

**R√©ponse** :
```json
{
  "success": true,
  "data": {
    "id": "wallet-uuid",
    "agent_id": "agent-uuid",
    "balance": "100000",
    "currency": "FCFA",
    "status": "ACTIVE",
    "low_balance_alert": false,
    "created_at": "2025-11-05T10:00:00Z",
    "updated_at": "2025-11-05T18:00:00Z"
  }
}
```

#### Recharger mon wallet (Agent)

```bash
POST /api/wallet/recharge
Authorization: Bearer <agent_token>
Content-Type: application/json

{
  "amount": 50000,
  "payment_method": "MOBILE_MONEY",
  "external_reference": "MM-REF-123456"
}
```

#### Historique des transactions (Agent)

```bash
GET /api/wallet/transactions?limit=50
Authorization: Bearer <agent_token>
```

**R√©ponse** :
```json
{
  "success": true,
  "data": [
    {
      "id": "tx-uuid",
      "wallet_id": "wallet-uuid",
      "type": "RECHARGE",
      "amount": "50000",
      "balance_before": "50000",
      "balance_after": "100000",
      "status": "COMPLETED",
      "description": "Recharge Mobile Money",
      "created_at": "2025-11-05T18:00:00Z"
    },
    {
      "id": "tx-uuid-2",
      "wallet_id": "wallet-uuid",
      "type": "DEDUCTION",
      "amount": "165",
      "balance_before": "100000",
      "balance_after": "99835",
      "status": "COMPLETED",
      "description": "Commission livraison #ORD-123456",
      "created_at": "2025-11-05T18:05:00Z"
    }
  ]
}
```

#### Paiements non r√©gl√©s (Agent)

```bash
GET /api/wallet/payments/unsettled
Authorization: Bearer <agent_token>
```

#### Solde d√ª √† la plateforme (Agent)

```bash
GET /api/wallet/balance-due
Authorization: Bearer <agent_token>
```

## üîí S√©curit√© & Permissions

### Endpoints Publics
- ‚úÖ `GET /api/delivery/pricing/config` - Consulter configuration
- ‚úÖ `POST /api/delivery/pricing/calculate` - Calculer prix
- ‚úÖ `GET /api/delivery/pricing/zones` - Lister zones

### Endpoints Super Admin
- üîí `PUT /api/delivery/pricing/config` - Modifier configuration
- üîí `GET /api/delivery/pricing/history` - Historique modifications
- üîí `POST /api/delivery/pricing/zones` - Cr√©er zone
- üîí `DELETE /api/delivery/pricing/zones/:id` - Supprimer zone

### Endpoints Agent
- üîê `GET /api/wallet` - Consulter wallet
- üîê `POST /api/wallet/recharge` - Recharger
- üîê `GET /api/wallet/transactions` - Historique
- üîê `GET /api/wallet/payments/unsettled` - Paiements non r√©gl√©s
- üîê `GET /api/wallet/balance-due` - Solde d√ª

## üìä Cas d'Usage

### Activer le Mode Gratuit

```bash
curl -X PUT https://api.ono.ci/api/delivery/pricing/config \
  -H "Authorization: Bearer $SUPER_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "fees_enabled": false,
    "reason": "Promotion lancement - Livraisons gratuites"
  }'
```

### D√©sactiver la Commission Agent

```bash
curl -X PUT https://api.ono.ci/api/delivery/pricing/config \
  -H "Authorization: Bearer $SUPER_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "agent_commission_enabled": false,
    "reason": "P√©riode d'essai - Pas de commission"
  }'
```

### Activer Multiplicateurs (Rush Hour)

```bash
curl -X PUT https://api.ono.ci/api/delivery/pricing/config \
  -H "Authorization: Bearer $SUPER_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "rush_hour_multiplier": 0.25,
    "rush_hours": {
      "enabled": true,
      "periods": [
        {"start": "07:00", "end": "09:00"},
        {"start": "17:00", "end": "19:00"}
      ]
    },
    "reason": "Activation tarif heures de pointe"
  }'
```

### Passer en Mode Flat Rate Zone

```bash
# 1. Activer le mode
curl -X PUT https://api.ono.ci/api/delivery/pricing/config \
  -H "Authorization: Bearer $SUPER_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "pricing_mode": "FLAT_RATE_ZONE",
    "reason": "Activation tarif forfaitaire par commune"
  }'

# 2. Cr√©er les zones
curl -X POST https://api.ono.ci/api/delivery/pricing/zones \
  -H "Authorization: Bearer $SUPER_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Cocody",
    "flat_rate_enabled": true,
    "flat_rate_price": 800.0,
    "flat_rate_max_distance_km": 10.0,
    "geometry": {...}
  }'
```

## üß™ Tests

Collection Postman mise √† jour disponible : `ONO_DELIVERY_Complete.postman_collection.json`

### Sc√©narios Test√©s

- ‚úÖ R√©cup√©ration configuration (mode STANDARD)
- ‚úÖ Calcul prix mode STANDARD (10 km = 1500 FCFA)
- ‚úÖ Calcul prix avec multiplicateurs
- ‚úÖ Cr√©ation wallet automatique
- ‚úÖ Recharge wallet (50000 FCFA)
- ‚úÖ V√©rification solde avant assignation
- ‚úÖ D√©duction automatique apr√®s assignation (15%)
- ‚úÖ Protection : Pas de d√©duction sans assignation
- ‚úÖ Historique transactions
- ‚úÖ Paiements non r√©gl√©s

## üìö Voir Aussi

- [Standard Delivery](/api-reference/delivery-standard) - API livraisons standard
- [Grouped Delivery](/api-reference/delivery-grouped) - API livraisons group√©es
- [Moving Service](/api-reference/delivery-moving) - API d√©m√©nagement
- [Delivery Overview](/api-reference/delivery-overview) - Vue d'ensemble
