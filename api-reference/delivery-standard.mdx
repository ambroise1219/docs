# Standard Delivery API

<Note>
  **Production Ready** - API compl√®te pour livraisons point-√†-point simples et express
</Note>

La livraison standard permet des livraisons point-√†-point avec deux niveaux de service : STANDARD (2-4h) et EXPRESS (30-60min).

## üöÄ Quick Start

<Steps>
  <Step title="Estimer le prix">
    Calculez le co√ªt avant de cr√©er la commande
  </Step>
  <Step title="Cr√©er la commande">
    Cr√©ez la commande avec les d√©tails de livraison
  </Step>
  <Step title="Assigner un agent">
    Le syst√®me assigne automatiquement un agent disponible
  </Step>
  <Step title="Suivre en temps r√©el">
    Suivez la progression via Socket.io
  </Step>
</Steps>

## üì¶ Types de Livraison

<CardGroup cols={2}>
  <Card title="STANDARD" icon="box">
    Livraison simple (2-4h)
    - Prix de base: 500 FCFA
    - Prix/km: 100 FCFA
    - Id√©al pour: Documents, colis non urgents
  </Card>
  
  <Card title="EXPRESS" icon="bolt">
    Livraison prioritaire (30-60min)
    - Prix de base: 700 FCFA
    - Prix/km: 120 FCFA
    - Id√©al pour: Documents urgents, m√©dicaments
  </Card>
</CardGroup>

## üíª Setup & Configuration

### Installation des d√©pendances

```bash
# Next.js / React
npm install @tanstack/react-query axios zod socket.io-client

# Expo / React Native
npx expo install @tanstack/react-query axios zod socket.io-client
```

### Configuration Axios

```typescript
// lib/api/axios.ts
import axios from 'axios';

const api = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_URL || 'https://api.ono.ci',
  headers: {
    'Content-Type': 'application/json',
  },
});

// Intercepteur pour ajouter le token
api.interceptors.request.use((config) => {
  const token = localStorage.getItem('access_token'); // ou AsyncStorage pour Expo
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// Intercepteur pour g√©rer les erreurs
api.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      // Rediriger vers login
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);

export default api;
```

### Configuration TanStack Query

```typescript
// lib/api/query-client.ts
import { QueryClient } from '@tanstack/react-query';

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 1000 * 60 * 5, // 5 minutes
      retry: 3,
      retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
    },
  },
});
```

```typescript
// app/layout.tsx (Next.js) ou App.tsx (Expo)
import { QueryClientProvider } from '@tanstack/react-query';
import { queryClient } from '@/lib/api/query-client';

export default function RootLayout({ children }) {
  return (
    <QueryClientProvider client={queryClient}>
      {children}
    </QueryClientProvider>
  );
}
```

### Configuration Socket.io

```typescript
// lib/api/socket.ts
import { io, Socket } from 'socket.io-client';

let socket: Socket | null = null;

export const initSocket = (token: string) => {
  if (socket) return socket;
  
  socket = io(process.env.NEXT_PUBLIC_WS_URL || 'wss://api.ono.ci', {
    auth: { token },
    transports: ['websocket'],
  });
  
  socket.on('connect', () => {
    console.log('‚úÖ Socket connect√©');
  });
  
  socket.on('disconnect', () => {
    console.log('‚ùå Socket d√©connect√©');
  });
  
  return socket;
};

export const getSocket = () => socket;

export const disconnectSocket = () => {
  if (socket) {
    socket.disconnect();
    socket = null;
  }
};
```

## üìù Sch√©mas Zod

```typescript
// lib/schemas/delivery.schema.ts
import { z } from 'zod';

export const LocationSchema = z.object({
  lat: z.number().min(-90).max(90),
  lng: z.number().min(-180).max(180),
});

export const CreateDeliverySchema = z.object({
  pickup_address: z.string().min(5, 'Adresse trop courte'),
  pickup_location: LocationSchema,
  pickup_contact: z.string().regex(/^\+225\d{10}$/, 'Format: +225XXXXXXXXXX'),
  delivery_address: z.string().min(5, 'Adresse trop courte'),
  delivery_location: LocationSchema,
  delivery_contact: z.string().regex(/^\+225\d{10}$/, 'Format: +225XXXXXXXXXX'),
  package_description: z.string().min(3, 'Description requise'),
  is_fragile: z.boolean().default(false),
  delivery_type: z.enum(['STANDARD', 'EXPRESS']),
  priority: z.enum(['Normal', 'Urgent']).default('Normal'),
  payment_method: z.enum(['Cash', 'Card', 'MobileMoney']),
});

export const EstimatePriceSchema = z.object({
  pickup_location: LocationSchema,
  delivery_location: LocationSchema,
  delivery_type: z.enum(['STANDARD', 'EXPRESS']),
});

export type CreateDeliveryInput = z.infer<typeof CreateDeliverySchema>;
export type EstimatePriceInput = z.infer<typeof EstimatePriceSchema>;

// Sch√©mas de r√©ponse
export const OrderSchema = z.object({
  id: z.string().uuid(),
  order_number: z.string(),
  status: z.enum([
    'Pending',
    'Assigned',
    'EnRouteToPickup',
    'ArrivedAtPickup',
    'PackagePickedUp',
    'EnRouteToDelivery',
    'ArrivedAtDelivery',
    'Delivered',
    'Cancelled',
  ]),
  delivery_type: z.enum(['STANDARD', 'EXPRESS']),
  total_price: z.number(),
  created_at: z.string().datetime(),
  agent: z.object({
    id: z.string().uuid(),
    name: z.string(),
    phone: z.string(),
    current_location: LocationSchema.optional(),
  }).optional(),
});

export type Order = z.infer<typeof OrderSchema>;
```

## üîå API Hooks (TanStack Query)

```typescript
// lib/api/hooks/useDelivery.ts
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';
import api from '../axios';
import { CreateDeliveryInput, EstimatePriceInput, Order } from '@/lib/schemas/delivery.schema';

// Estimer le prix
export const useEstimatePrice = () => {
  return useMutation({
    mutationFn: async (data: EstimatePriceInput) => {
      const response = await api.post('/api/delivery/standard/estimate', data);
      return response.data.data;
    },
  });
};

// Cr√©er une commande
export const useCreateDelivery = () => {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: async (data: CreateDeliveryInput) => {
      const response = await api.post('/api/delivery/standard/orders', data);
      return response.data.data as Order;
    },
    onSuccess: () => {
      // Invalider la liste des commandes
      queryClient.invalidateQueries({ queryKey: ['deliveries'] });
    },
  });
};

// R√©cup√©rer une commande
export const useDelivery = (orderId: string) => {
  return useQuery({
    queryKey: ['delivery', orderId],
    queryFn: async () => {
      const response = await api.get(`/api/delivery/standard/orders/${orderId}`);
      return response.data.data as Order;
    },
    enabled: !!orderId,
    refetchInterval: (data) => {
      // Arr√™ter le polling si livr√© ou annul√©
      if (data?.status === 'Delivered' || data?.status === 'Cancelled') {
        return false;
      }
      return 10000; // Poll toutes les 10 secondes
    },
  });
};

// Lister mes commandes
export const useDeliveries = (page = 1, perPage = 10, status?: string) => {
  return useQuery({
    queryKey: ['deliveries', page, perPage, status],
    queryFn: async () => {
      const params = new URLSearchParams({
        page: page.toString(),
        per_page: perPage.toString(),
        ...(status && { status }),
      });
      const response = await api.get(`/api/delivery/standard/orders?${params}`);
      return response.data;
    },
  });
};

// Annuler une commande
export const useCancelDelivery = () => {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: async ({ orderId, reason }: { orderId: string; reason: string }) => {
      const response = await api.post(`/api/delivery/standard/orders/${orderId}/cancel`, {
        reason,
      });
      return response.data.data;
    },
    onSuccess: (_, variables) => {
      // Invalider la commande sp√©cifique et la liste
      queryClient.invalidateQueries({ queryKey: ['delivery', variables.orderId] });
      queryClient.invalidateQueries({ queryKey: ['deliveries'] });
    },
  });
};
```

## üé® Composants React / Next.js

### Formulaire de cr√©ation de commande

```typescript
// components/CreateDeliveryForm.tsx
'use client';

import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { CreateDeliverySchema, CreateDeliveryInput } from '@/lib/schemas/delivery.schema';
import { useCreateDelivery, useEstimatePrice } from '@/lib/api/hooks/useDelivery';
import { useState } from 'react';

export default function CreateDeliveryForm() {
  const [estimate, setEstimate] = useState<number | null>(null);
  
  const { mutate: estimatePrice, isPending: isEstimating } = useEstimatePrice();
  const { mutate: createDelivery, isPending: isCreating } = useCreateDelivery();
  
  const {
    register,
    handleSubmit,
    watch,
    formState: { errors },
  } = useForm<CreateDeliveryInput>({
    resolver: zodResolver(CreateDeliverySchema),
    defaultValues: {
      delivery_type: 'STANDARD',
      priority: 'Normal',
      is_fragile: false,
    },
  });
  
  const pickupLocation = watch('pickup_location');
  const deliveryLocation = watch('delivery_location');
  const deliveryType = watch('delivery_type');
  
  const handleEstimate = () => {
    if (pickupLocation && deliveryLocation && deliveryType) {
      estimatePrice(
        { pickup_location: pickupLocation, delivery_location: deliveryLocation, delivery_type: deliveryType },
        {
          onSuccess: (data) => {
            setEstimate(data.total_price);
          },
        }
      );
    }
  };
  
  const onSubmit = (data: CreateDeliveryInput) => {
    createDelivery(data, {
      onSuccess: (order) => {
        // Rediriger vers le suivi
        window.location.href = `/track/${order.id}`;
      },
      onError: (error: any) => {
        alert(error.response?.data?.message || 'Erreur lors de la cr√©ation');
      },
    });
  };
  
  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
      <div>
        <label>Type de livraison</label>
        <select {...register('delivery_type')} className="w-full p-2 border rounded">
          <option value="STANDARD">Standard (2-4h)</option>
          <option value="EXPRESS">Express (30-60min)</option>
        </select>
      </div>
      
      <div>
        <label>Adresse de ramassage</label>
        <input
          {...register('pickup_address')}
          className="w-full p-2 border rounded"
          placeholder="Cocody Riviera"
        />
        {errors.pickup_address && (
          <p className="text-red-500 text-sm">{errors.pickup_address.message}</p>
        )}
      </div>
      
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label>Latitude</label>
          <input
            {...register('pickup_location.lat', { valueAsNumber: true })}
            type="number"
            step="any"
            className="w-full p-2 border rounded"
          />
        </div>
        <div>
          <label>Longitude</label>
          <input
            {...register('pickup_location.lng', { valueAsNumber: true })}
            type="number"
            step="any"
            className="w-full p-2 border rounded"
          />
        </div>
      </div>
      
      <div>
        <label>Contact ramassage</label>
        <input
          {...register('pickup_contact')}
          className="w-full p-2 border rounded"
          placeholder="+225 0707070707"
        />
        {errors.pickup_contact && (
          <p className="text-red-500 text-sm">{errors.pickup_contact.message}</p>
        )}
      </div>
      
      {/* R√©p√©ter pour delivery_address, delivery_location, delivery_contact */}
      
      <div>
        <label>Description du colis</label>
        <textarea
          {...register('package_description')}
          className="w-full p-2 border rounded"
          placeholder="Documents importants"
        />
      </div>
      
      <div className="flex items-center gap-2">
        <input {...register('is_fragile')} type="checkbox" />
        <label>Colis fragile</label>
      </div>
      
      <div>
        <label>M√©thode de paiement</label>
        <select {...register('payment_method')} className="w-full p-2 border rounded">
          <option value="Cash">Esp√®ces</option>
          <option value="Card">Carte bancaire</option>
          <option value="MobileMoney">Mobile Money</option>
        </select>
      </div>
      
      <button
        type="button"
        onClick={handleEstimate}
        disabled={isEstimating}
        className="w-full bg-gray-200 p-2 rounded"
      >
        {isEstimating ? 'Calcul...' : 'Estimer le prix'}
      </button>
      
      {estimate && (
        <div className="bg-green-50 p-4 rounded">
          <p className="text-lg font-bold">Prix estim√©: {estimate} FCFA</p>
        </div>
      )}
      
      <button
        type="submit"
        disabled={isCreating}
        className="w-full bg-blue-500 text-white p-2 rounded"
      >
        {isCreating ? 'Cr√©ation...' : 'Cr√©er la commande'}
      </button>
    </form>
  );
}
```

### Suivi de commande en temps r√©el

```typescript
// components/DeliveryTracker.tsx
'use client';

import { useDelivery } from '@/lib/api/hooks/useDelivery';
import { useEffect, useState } from 'react';
import { getSocket, initSocket } from '@/lib/api/socket';

interface DeliveryTrackerProps {
  orderId: string;
}

export default function DeliveryTracker({ orderId }: DeliveryTrackerProps) {
  const { data: order, isLoading } = useDelivery(orderId);
  const [agentLocation, setAgentLocation] = useState<{ lat: number; lng: number } | null>(null);
  
  useEffect(() => {
    const token = localStorage.getItem('access_token');
    if (!token) return;
    
    const socket = initSocket(token);
    
    // S'abonner aux mises √† jour de la commande
    socket.emit('subscribe:order', orderId);
    
    // √âcouter les mises √† jour de statut
    socket.on('order:status_updated', (data) => {
      if (data.order_id === orderId) {
        console.log('Nouveau statut:', data.status);
        // TanStack Query va automatiquement refetch
      }
    });
    
    // √âcouter les mises √† jour de position de l'agent
    socket.on('agent:location_updated', (data) => {
      if (data.order_id === orderId) {
        setAgentLocation(data.location);
      }
    });
    
    return () => {
      socket.emit('unsubscribe:order', orderId);
      socket.off('order:status_updated');
      socket.off('agent:location_updated');
    };
  }, [orderId]);
  
  if (isLoading) {
    return <div>Chargement...</div>;
  }
  
  if (!order) {
    return <div>Commande non trouv√©e</div>;
  }
  
  return (
    <div className="space-y-4">
      <div className="bg-white p-4 rounded shadow">
        <h2 className="text-xl font-bold">Commande {order.order_number}</h2>
        <StatusBadge status={order.status} />
      </div>
      
      {order.agent && (
        <div className="bg-white p-4 rounded shadow">
          <h3 className="font-bold">Votre livreur</h3>
          <p>{order.agent.name}</p>
          <a href={`tel:${order.agent.phone}`} className="text-blue-500">
            {order.agent.phone}
          </a>
        </div>
      )}
      
      <div className="bg-white p-4 rounded shadow">
        <h3 className="font-bold">Itin√©raire</h3>
        {/* Int√©grer Google Maps ou Mapbox ici */}
        <Map
          pickupLocation={order.pickup_location}
          deliveryLocation={order.delivery_location}
          agentLocation={agentLocation || order.agent?.current_location}
        />
      </div>
      
      <StatusTimeline status={order.status} />
    </div>
  );
}

function StatusBadge({ status }: { status: string }) {
  const colors = {
    Pending: 'bg-yellow-100 text-yellow-800',
    Assigned: 'bg-blue-100 text-blue-800',
    EnRouteToPickup: 'bg-purple-100 text-purple-800',
    PackagePickedUp: 'bg-indigo-100 text-indigo-800',
    EnRouteToDelivery: 'bg-orange-100 text-orange-800',
    Delivered: 'bg-green-100 text-green-800',
    Cancelled: 'bg-red-100 text-red-800',
  };
  
  return (
    <span className={`px-3 py-1 rounded-full text-sm ${colors[status] || 'bg-gray-100'}`}>
      {status}
    </span>
  );
}
```

## üì± Composants Expo / React Native

```typescript
// components/CreateDeliveryScreen.tsx
import { View, Text, TextInput, TouchableOpacity, ScrollView } from 'react-native';
import { useForm, Controller } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { CreateDeliverySchema, CreateDeliveryInput } from '@/lib/schemas/delivery.schema';
import { useCreateDelivery } from '@/lib/api/hooks/useDelivery';
import { useRouter } from 'expo-router';

export default function CreateDeliveryScreen() {
  const router = useRouter();
  const { mutate: createDelivery, isPending } = useCreateDelivery();
  
  const {
    control,
    handleSubmit,
    formState: { errors },
  } = useForm<CreateDeliveryInput>({
    resolver: zodResolver(CreateDeliverySchema),
  });
  
  const onSubmit = (data: CreateDeliveryInput) => {
    createDelivery(data, {
      onSuccess: (order) => {
        router.push(`/track/${order.id}`);
      },
      onError: (error: any) => {
        alert(error.response?.data?.message || 'Erreur');
      },
    });
  };
  
  return (
    <ScrollView className="flex-1 p-4">
      <Text className="text-2xl font-bold mb-4">Nouvelle livraison</Text>
      
      <Controller
        control={control}
        name="pickup_address"
        render={({ field: { onChange, value } }) => (
          <View className="mb-4">
            <Text className="mb-2">Adresse de ramassage</Text>
            <TextInput
              value={value}
              onChangeText={onChange}
              className="border p-3 rounded"
              placeholder="Cocody Riviera"
            />
            {errors.pickup_address && (
              <Text className="text-red-500 text-sm mt-1">
                {errors.pickup_address.message}
              </Text>
            )}
          </View>
        )}
      />
      
      {/* Autres champs... */}
      
      <TouchableOpacity
        onPress={handleSubmit(onSubmit)}
        disabled={isPending}
        className="bg-blue-500 p-4 rounded mt-4"
      >
        <Text className="text-white text-center font-bold">
          {isPending ? 'Cr√©ation...' : 'Cr√©er la commande'}
        </Text>
      </TouchableOpacity>
    </ScrollView>
  );
}
```

## üîå √âv√©nements Socket.io

### √âv√©nements disponibles

```typescript
// √âv√©nements √† √©couter
socket.on('order:status_updated', (data: {
  order_id: string;
  status: string;
  previous_status: string;
  updated_at: string;
}) => {
  console.log('Statut mis √† jour:', data);
});

socket.on('agent:location_updated', (data: {
  order_id: string;
  agent_id: string;
  location: { lat: number; lng: number };
  timestamp: string;
}) => {
  console.log('Position agent:', data);
});

socket.on('order:assigned', (data: {
  order_id: string;
  agent: {
    id: string;
    name: string;
    phone: string;
  };
}) => {
  console.log('Agent assign√©:', data);
});

// √âv√©nements √† √©mettre
socket.emit('subscribe:order', orderId);
socket.emit('unsubscribe:order', orderId);
```

## üì° Endpoints API

### 1. Estimer le prix

```bash
POST /api/delivery/standard/estimate
```

**R√©ponse** :
```json
{
  "success": true,
  "data": {
    "base_price": 500.0,
    "distance_km": 4.97,
    "distance_price": 497.0,
    "total_price": 1000.0,
    "estimated_duration_minutes": 15
  }
}
```

### 2. Cr√©er une commande

```bash
POST /api/delivery/standard/orders
```

### 3. R√©cup√©rer une commande

```bash
GET /api/delivery/standard/orders/{order_id}
```

### 4. Lister mes commandes

```bash
GET /api/delivery/standard/orders?page=1&per_page=10
```

### 5. Annuler une commande

```bash
POST /api/delivery/standard/orders/{order_id}/cancel
```

## üí∞ Tarification

<Note>
  Les prix sont configurables via le syst√®me de Pricing. Voir [Pricing & Wallet](/api-reference/delivery-pricing-wallet)
</Note>

### Standard
- **Prix de base**: 500 FCFA
- **Prix par km**: 100 FCFA/km
- **D√©lai**: 2-4 heures

### Express
- **Prix de base**: 700 FCFA
- **Prix par km**: 120 FCFA/km
- **D√©lai**: 30-60 minutes

## üîí Best Practices

### 1. Gestion des tokens

```typescript
// lib/auth/token.ts
import AsyncStorage from '@react-native-async-storage/async-storage'; // Expo
// ou localStorage pour Next.js

export const saveToken = async (token: string) => {
  await AsyncStorage.setItem('access_token', token);
};

export const getToken = async () => {
  return await AsyncStorage.getItem('access_token');
};

export const removeToken = async () => {
  await AsyncStorage.removeItem('access_token');
};
```

### 2. Error Boundary

```typescript
// components/ErrorBoundary.tsx
import { QueryErrorResetBoundary } from '@tanstack/react-query';
import { ErrorBoundary as ReactErrorBoundary } from 'react-error-boundary';

export function ErrorBoundary({ children }: { children: React.ReactNode }) {
  return (
    <QueryErrorResetBoundary>
      {({ reset }) => (
        <ReactErrorBoundary
          onReset={reset}
          fallbackRender={({ error, resetErrorBoundary }) => (
            <div className="p-4">
              <h2>Une erreur est survenue</h2>
              <pre>{error.message}</pre>
              <button onClick={resetErrorBoundary}>R√©essayer</button>
            </div>
          )}
        >
          {children}
        </ReactErrorBoundary>
      )}
    </QueryErrorResetBoundary>
  );
}
```

### 3. Optimistic Updates

```typescript
export const useCancelDelivery = () => {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: async ({ orderId, reason }) => {
      const response = await api.post(`/api/delivery/standard/orders/${orderId}/cancel`, {
        reason,
      });
      return response.data.data;
    },
    onMutate: async ({ orderId }) => {
      // Annuler les requ√™tes en cours
      await queryClient.cancelQueries({ queryKey: ['delivery', orderId] });
      
      // Snapshot de la valeur pr√©c√©dente
      const previousOrder = queryClient.getQueryData(['delivery', orderId]);
      
      // Mise √† jour optimiste
      queryClient.setQueryData(['delivery', orderId], (old: any) => ({
        ...old,
        status: 'Cancelled',
      }));
      
      return { previousOrder };
    },
    onError: (err, variables, context) => {
      // Rollback en cas d'erreur
      if (context?.previousOrder) {
        queryClient.setQueryData(['delivery', variables.orderId], context.previousOrder);
      }
    },
    onSettled: (_, __, variables) => {
      queryClient.invalidateQueries({ queryKey: ['delivery', variables.orderId] });
    },
  });
};
```

## üìö Voir Aussi

- [Grouped Delivery](/api-reference/delivery-grouped) - Livraisons multi-zones
- [Moving Service](/api-reference/delivery-moving) - Service de d√©m√©nagement
- [Pricing & Wallet](/api-reference/delivery-pricing-wallet) - Configuration des frais
