# Architecture

L'API ONO Backend suit une architecture modulaire et multi-base de donnÃ©es conÃ§ue pour optimiser les performances, la sÃ©curitÃ© et la scalabilitÃ©.

## ğŸ—„ï¸ Structure Multi-Base de DonnÃ©es

ONO utilise une architecture multi-database pour optimiser les performances, la sÃ©curitÃ© et la scalabilitÃ©. Chaque branche mÃ©tier dispose de sa propre base de donnÃ©es, avec une base centrale pour les donnÃ©es partagÃ©es.

### Bases de DonnÃ©es par Domaine

#### SHARED DB - Base Principale
Contenu : DonnÃ©es centrales et partagÃ©es
- `users` - Table centrale des utilisateurs
- `auth_sessions` - Sessions d'authentification 
- `global_logs` - Logs d'audit cross-branches
- `global_notifications` - Notifications inter-branches
- `cross_branch_relations` - Relations entre branches
- `system_config` - Configuration systÃ¨me

#### DELIVERY DB - Livraison
Contenu : SystÃ¨me de livraison unifiÃ©
- `delivery_zones` - Zones gÃ©ographiques de livraison
- `vehicles` - VÃ©hicules des livreurs
- `delivery_agents` - Agents avec tracking GPS
- `delivery_orders` - Commandes de livraison
- `delivery_tracking` - Suivi temps rÃ©el
- `delivery_ratings` - Ã‰valuations des livraisons
- `delivery_incidents` - Gestion des problÃ¨mes

#### FOOD DB - Restaurants
Contenu : Ã‰cosystÃ¨me restaurant et food delivery
- `restaurants` - Restaurants partenaires
- `food_categories` - CatÃ©gories de plats
- `dishes` - Menu et plats avec nutrition
- `food_orders` - Commandes restaurant
- `food_order_items` - Items avec personnalisations
- `food_reviews` - Avis clients dÃ©taillÃ©s
- `food_promotions` - Codes promo et rÃ©ductions

#### SOCIAL DB - MÃ©dia Social
Contenu : Plateforme social media complÃ¨te
- `posts` - Publications avec mÃ©dias
- `live_streams` - Lives en temps rÃ©el
- `comments` - Commentaires avec threading
- `likes` - Likes et rÃ©actions
- `follows` - Abonnements utilisateurs
- `conversations` - Chat privÃ© et groupes
- `messages` - Messages avec mÃ©dias
- `notifications` - Notifications push
- `trending_hashtags` - Tendances
- `reports` - ModÃ©ration de contenu

#### GROCERIES DB - Ã‰picerie
Contenu : SupermarchÃ©s et produits alimentaires
- `grocery_stores` - Magasins partenaires
- `product_categories` - CatÃ©gories hiÃ©rarchiques
- `products` - Catalogue avec stock
- `grocery_orders` - Commandes Ã©picerie
- `grocery_order_items` - Items avec substitutions

#### PHARMACY DB - Pharmacie & SantÃ©
Contenu : Pharmacies et consultations mÃ©dicales
- `pharmacies` - Pharmacies agrÃ©Ã©es
- `medicine_categories` - CatÃ©gories mÃ©dicales
- `medicines` - Catalogue mÃ©dicaments
- `doctors` - MÃ©decins certifiÃ©s
- `prescriptions` - Ordonnances validÃ©es
- `prescription_items` - MÃ©dicaments prescrits
- `medical_consultations` - TÃ©lÃ©consultations
- `pharmacy_orders` - Commandes avec assurance

## ğŸ—ï¸ Structure Modulaire

Le code est organisÃ© en modules mÃ©tier suivant le pattern handlers â†’ services â†’ repository :

```
src/modules/
â”œâ”€â”€ auth/
â”œâ”€â”€ delivery/
â”œâ”€â”€ food/
â”œâ”€â”€ groceries/
â”œâ”€â”€ housing/
â”œâ”€â”€ insurance/
â”œâ”€â”€ pharmacy/
â”œâ”€â”€ social/
â””â”€â”€ users/
```

Chaque module contient :
- `handlers/` - Couche HTTP (validation, extraction, status codes)
- `services/` - Logique mÃ©tier orchestrant dÃ©pÃ´ts, validation, sideâ€‘effects
- `repository/` - RequÃªtes SQLx typÃ©es par entitÃ©
- `models/` - EntitÃ©s persistÃ©es et DTOs

## ğŸ”Œ Ã‰tat Applicatif et Services

L'Ã©tat de l'application est gÃ©rÃ© par `AppState` qui expose :

```
AppState (Arc)
â”œâ”€ db_pools: DatabaseManager
â”œâ”€ config: EnvironmentConfig
â”œâ”€ pulse: PulseState
â”œâ”€ services
â”‚  â”œâ”€ FoodService (pool: food)
â”‚  â”œâ”€ OtpService (Wanotifier + rÃ¨gles OTP)
â”‚  â”œâ”€ OtpAuthService (pool: shared + JWT)
â”‚  â”œâ”€ AuthService (refresh/logout + JWT)
â”‚  â””â”€ UserService (pool: shared)
â””â”€ exposÃ© aux handlers via Axum .with_state(AppState)
```

## ğŸ¯ Avantages de cette Architecture

### Performance
- **Isolation des charges** - Chaque branche a ses propres ressources
- **Scaling indÃ©pendant** - Optimisation par usage
- **Pas de contention** - Pas de conflits entre branches
- **Index spÃ©cialisÃ©s** - OptimisÃ©s pour chaque domaine

### SÃ©curitÃ©
- **Isolation des donnÃ©es** - DonnÃ©es mÃ©dicales sÃ©parÃ©es
- **AccÃ¨s granulaire** - Permissions par branche
- **Audit sÃ©parÃ©** - Logs spÃ©cialisÃ©s par domaine
- **ConformitÃ©** - RGPD facilitÃ© par l'isolation

### Maintenance
- **Migrations indÃ©pendantes** - DÃ©ploiements sans impact
- **Rollback isolÃ©** - ProblÃ¨mes contenus
- **Monitoring spÃ©cialisÃ©** - MÃ©triques par branche
- **Backup sÃ©lectif** - Sauvegarde ciblÃ©e

## ğŸ”” Pu
lse - SystÃ¨me de Notifications Temps RÃ©el

Pulse est le systÃ¨me de messagerie temps rÃ©el d'ONO qui gÃ¨re toutes les notifications et communications entre services.

### Composants Principaux

- **Event Bus Hybride** : Redis (persistance) + Broadcast (temps rÃ©el en mÃ©moire)
- **gRPC Server** : Communication haute performance sur port 50052
- **SSE** : Server-Sent Events pour notifications web
- **WebSocket** : Communication bidirectionnelle pour chat et tracking
- **Cache Redis** : Optimisation des performances et sessions

### Flux de Notifications

```
Service (Food/Delivery/etc.)
    â†“
Pulse Event Bus
    â†“
â”œâ”€â†’ Redis Streams (persistance)
â””â”€â†’ Broadcast Channel (temps rÃ©el)
    â†“
Consumer
    â†“
ConnectionManager
    â†“
Clients (SSE/WebSocket/gRPC)
```

### Ã‰vÃ©nements Disponibles

**Module Food**
- `food.order.created` - Nouvelle commande crÃ©Ã©e
- `food.order.status_changed` - Changement de statut
- `food.delivery.assigned` - Livreur assignÃ©

**Module Delivery**
- `delivery.status_updated` - Mise Ã  jour statut livraison
- `delivery.location_updated` - Position GPS du livreur
- `delivery.completed` - Livraison terminÃ©e

### Configuration

```bash
# Event Bus Type
EVENT_BUS_TYPE=hybrid  # ou redis, nats, kafka

# Redis
REDIS_URL=redis://localhost:6379
REDIS_MAX_CONNECTIONS=50

# gRPC
GRPC_PORT=50052
```

Voir [Documentation Pulse](/api-reference/pulse) et [Guide d'IntÃ©gration](/guides/pulse-integration) pour plus de dÃ©tails.
