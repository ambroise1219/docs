# Deployment

Ce guide explique comment d√©ployer l'API ONO Backend en production.

## üéØ Environnements de d√©ploiement

L'API ONO Backend peut √™tre d√©ploy√©e dans diff√©rents environnements :

- **Serveurs d√©di√©s**
- **Cloud (AWS, Google Cloud, Azure)**
- **Kubernetes**
- **Docker Swarm**

## üì¶ Pr√©requis de d√©ploiement

Avant de d√©ployer, assurez-vous d'avoir :

1. **Rust toolchain** install√©e sur le serveur cible
2. **PostgreSQL** avec les bases de donn√©es cr√©√©es
3. **Redis** en cours d'ex√©cution
4. **Acc√®s aux variables d'environnement de production**

## üöÄ D√©ploiement manuel

### 1. Compilation pour la production

Compilez l'application avec les optimisations de production :

```bash
cargo build --release
```

Ou utilisez le profil ultra-optimis√© :

```bash
cargo build --profile release-ultra
```

### 2. Configuration de l'environnement

Cr√©ez un fichier `.env.production` avec les variables de production :

```env
# Configuration de base
ENVIRONMENT=production
JWT_SECRET=your-super-secret-production-jwt-key
LOG_LEVEL=info

# Bases de donn√©es
ONO_MAIN_DATABASE_URL=postgresql://user:password@db-host:5432/ono_main
ONO_FOOD_DATABASE_URL=postgresql://user:password@db-host:5432/ono_food
ONO_DELIVERY_DATABASE_URL=postgresql://user:password@db-host:5432/ono_delivery
ONO_MEDICAL_DATABASE_URL=postgresql://user:password@db-host:5432/ono_medical
DATABASE_URL=postgresql://user:password@db-host:5432/ono_main

# Redis
REDIS_URL=redis://redis-host:6379

# Configuration OTP/Wanotifier
WANOTIFIER_API_KEY=your-production-wanotifier-api-key
WANOTIFIER_API_URL=https://api.wanotifier.com/v1
OTP_EXPIRATION_MINUTES=5
OTP_MAX_ATTEMPTS=3

# Configuration de performance
MAX_CONNECTIONS=100
```

### 3. D√©ploiement des fichiers

Copiez les fichiers n√©cessaires sur le serveur :

```bash
scp target/release/ono-backend user@server:/app/ono-backend/
scp .env.production user@server:/app/ono-backend/.env
```

### 4. D√©marrage du service

D√©marrez l'application :

```bash
cd /app/ono-backend
./ono-backend
```

## üê≥ D√©ploiement avec Docker

### 1. Construction de l'image Docker

```dockerfile
FROM rust:1.70 as builder

WORKDIR /app
COPY . .
RUN cargo build --release

FROM debian:bullseye-slim

RUN apt-get update && apt-get install -y openssl ca-certificates \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

COPY --from=builder /app/target/release/ono-backend /usr/local/bin/ono-backend
COPY .env.production /app/.env

WORKDIR /app
CMD ["ono-backend"]
```

### 2. Construction et ex√©cution

```bash
docker build -t ono-backend:latest .
docker run -d -p 3000:3000 --env-file .env.production ono-backend:latest
```

## ‚ò∏Ô∏è D√©ploiement avec Kubernetes

### 1. Fichier de d√©ploiement (deployment.yaml)

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ono-backend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: ono-backend
  template:
    metadata:
      labels:
        app: ono-backend
    spec:
      containers:
      - name: ono-backend
        image: ono-backend:latest
        ports:
        - containerPort: 3000
        envFrom:
        - secretRef:
            name: ono-backend-secrets
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
---
apiVersion: v1
kind: Service
metadata:
  name: ono-backend-service
spec:
  selector:
    app: ono-backend
  ports:
    - protocol: TCP
      port: 80
      targetPort: 3000
  type: LoadBalancer
```

### 2. Secrets Kubernetes (secrets.yaml)

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: ono-backend-secrets
type: Opaque
data:
  JWT_SECRET: <base64-encoded-secret>
  ONO_MAIN_DATABASE_URL: <base64-encoded-url>
  ONO_FOOD_DATABASE_URL: <base64-encoded-url>
  ONO_DELIVERY_DATABASE_URL: <base64-encoded-url>
  ONO_MEDICAL_DATABASE_URL: <base64-encoded-url>
  REDIS_URL: <base64-encoded-url>
  WANOTIFIER_API_KEY: <base64-encoded-key>
```

### 3. Application des configurations

```bash
kubectl apply -f secrets.yaml
kubectl apply -f deployment.yaml
```

## üîÑ CI/CD avec GitHub Actions

### 1. Fichier de workflow (.github/workflows/deploy.yml)

```yaml
name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
        
    - name: Build
      run: cargo build --release
      
    - name: Run tests
      run: cargo test
      
    - name: Deploy to server
      uses: appleboy/scp-action@v0.1.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        source: "target/release/ono-backend,.env.production"
        target: "/app/ono-backend/"
        
    - name: Restart service
      uses: appleboy/ssh-action@v0.1.2
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        script: |
          cd /app/ono-backend
          systemctl restart ono-backend
```

## üìä Monitoring et Logging

### Configuration de tracing

L'application utilise `tracing` pour le logging. Configurez votre backend de logging pr√©f√©r√© :

```env
LOG_LEVEL=info
TRACING_ENDPOINT=https://your-tracing-backend.com
```

### Health checks

L'API expose des endpoints de sant√© :

```http
GET /health
```

R√©ponse :

```json
{
  "status": "healthy",
  "service": "ONO Backend API",
  "version": "1.0.0",
  "timestamp": "2023-01-01T00:00:00Z",
  "environment": "production",
  "features": {
    "multi_database": true,
    "real_time": true,
    "geo_location": true,
    "file_upload": true
  }
}
```

## üîí S√©curit√© en production

### Configuration HTTPS

Utilisez un reverse proxy comme Nginx pour g√©rer HTTPS :

```nginx
server {
    listen 443 ssl;
    server_name api.ono.app;
    
    ssl_certificate /path/to/certificate.crt;
    ssl_certificate_key /path/to/private.key;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### Variables d'environnement s√©curis√©es

Stockez les secrets dans un gestionnaire de secrets comme HashiCorp Vault ou AWS Secrets Manager.

### Mises √† jour de s√©curit√©

Configurez des alertes pour les mises √† jour de d√©pendances critiques :

```bash
cargo audit
```

## üìà Performance en production

### Profilage

Activez le profilage pour identifier les goulets d'√©tranglement :

```env
ENABLE_PROFILING=true
PROFILING_ENDPOINT=http://localhost:8080
```

### Configuration des connexions

Ajustez les param√®tres de pool de connexions selon votre charge :

```env
MAX_CONNECTIONS=100
MIN_CONNECTIONS=10
CONNECTION_TIMEOUT=30
```

## üîÑ Mises √† jour et rollbacks

### Proc√©dure de mise √† jour

1. Compilez la nouvelle version
2. Testez dans un environnement de staging
3. D√©ployez sur un sous-ensemble de serveurs
4. Surveillez les m√©triques
5. D√©ployez sur tous les serveurs

### Rollback en cas de probl√®me

```bash
# Revenir √† la version pr√©c√©dente
systemctl stop ono-backend
# Remplacer le binaire par l'ancienne version
systemctl start ono-backend
```